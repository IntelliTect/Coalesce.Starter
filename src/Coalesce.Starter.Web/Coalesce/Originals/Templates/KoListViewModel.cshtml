@inherits Microsoft.VisualStudio.Web.CodeGeneration.Templating.RazorTemplateBase
@using IntelliTect.Coalesce.TypeDefinition
@using IntelliTect.Coalesce.Utilities
@{
    ClassViewModel model = Model.Model;
    string moduleName = "ListViewModels";
    string viewModelModuleName = "ViewModels";
    string viewModelName = model.Name;
    if (!string.IsNullOrWhiteSpace(Model.AreaName))
    {
        moduleName = Model.AreaName + "." + moduleName;
        viewModelModuleName = Model.AreaName + "." + viewModelModuleName;
    }
    if (!string.IsNullOrWhiteSpace(Model.ModulePrefix))
    {
        moduleName = Model.ModulePrefix + "." + moduleName;
        viewModelModuleName = Model.ModulePrefix + "." + viewModelModuleName;
        viewModelName = Model.ModulePrefix + "." + viewModelName;
    }
    if (model.HasTypeScriptPartial)
    {
        viewModelName += ".Partial";
    }
}

/// <reference path="../coalesce.dependencies.d.ts" />

// Knockout List View Model for: @(model.Name)
// Auto Generated by IntelliTect.Coalesce

var baseUrl = baseUrl || '';

module @moduleName {

    // Add an enum for all methods that are static and IQueryable
    export enum @(model.Name)DataSources {
            Default,
            @foreach(var method in model.BaseViewModel.Methods.Where(m => m.IsIQueryableOfParent && m.IsClientMethod && m.IsStatic).OrderBy(m => m.Name))
            {
            @:@method.Name,
            }
        }
    export class @(model.ListViewModelClassName) extends Coalesce.BaseListViewModel<@(model.ListViewModelClassName), @viewModelModuleName.@(model.ViewModelClassName)> {
        protected modelName = "@(model.Name)";

        protected apiController = "/@(model.ApiUrl)";

        public modelKeyName = "@(model.PrimaryKey.JsVariable)";
        public dataSources = @(model.Name)DataSources;
        public itemClass = @viewModelModuleName.@(model.ViewModelClassName);

        public query: {
            where?: string;
            @(string.Join("\n            ", model.BaseViewModel.Properties.Where(f=>f.IsUrlParameter).Select(f=>$"{f.UrlParameterName}?:{f.Type.TsType};")))
        } = null;

        // The custom code to run in order to pull the initial datasource to use for the collection that should be returned
        public listDataSource: @(model.Name)DataSources = @(model.Name)DataSources.Default;

        public static coalesceConfig = new Coalesce.ListViewModelConfiguration<@(model.ListViewModelClassName), @viewModelModuleName.@(model.ViewModelClassName)>(Coalesce.GlobalConfiguration.listViewModel);
        public coalesceConfig = new Coalesce.ListViewModelConfiguration<@(model.ListViewModelClassName), @viewModelModuleName.@(model.ViewModelClassName)>(@(model.ListViewModelClassName).coalesceConfig);

        // Valid values
    @foreach (PropertyViewModel prop in model.Properties.Where(f => f.HasValidValues))
        {
        @:public @(prop.ValidValueListName.ToCamelCase()): KnockoutObservableArray<any> = ko.observableArray([]);
        @:public load@(prop.ValidValueListName): (callback: any) => void;
        }
    @foreach(var method in model.Methods.Where(m => m.IsStatic && m.IsClientMethod))
        {
        <text>
        // Call server method (@method.Name)
        @if (method.Comment.Length > 0)
        {
        @:// @(method.Comment)
        }
        public @method.JsVariable = (@method.TsParameters) => {
            this.@(method.JsVariableIsLoading)(true);
            this.@(method.JsVariableMessage)('');
            this.@(method.JsVariableWasSuccessful)(null);
            $.ajax({ method: "POST",
                     url: this.coalesceConfig.baseApiUrl() + "/@(method.ApiUrl)",
                     data: @method.JsPostObject,
                     xhrFields: { withCredentials: true } })
            .done((data) => {
                this.@(method.JsVariableResultRaw)(data.object);
                this.@(method.JsVariableMessage)('');
                this.@(method.JsVariableWasSuccessful)(true);
                @if (method.ReturnType.PureType.HasClassViewModel) {
                if (method.ReturnType.IsCollection)
                {
                @:if (this.@(method.JsVariableResult)()){
                // Merge the incoming array
                @if (method.ReturnType.PureType.ClassViewModel.PrimaryKey != null)
                {
                    @:Coalesce.KnockoutUtilities.RebuildArray(this.@(method.JsVariableResult), data.object, '@method.ReturnType.PureType.ClassViewModel.PrimaryKey.JsVariable', ViewModels.@method.ReturnType.PureType.ClassViewModel.Name, this, true);
                }
                else if (method.ReturnType.PureType.IsPrimitive)
                {
                    @:this.@(method.JsVariableResult)(data.object);
                }
                else
                {
                    @:Coalesce.KnockoutUtilities.RebuildArray(this.@(method.JsVariableResult), data.object, null, ViewModels.@method.ReturnType.PureType.ClassViewModel.Name, this, true);
                }
                @:}
                }
                else
                {
                @:if (!this.@(method.JsVariableResult)()){
                @:    this.@(method.JsVariableResult)(new ViewModels.@(method.ReturnType.PureType.ClassViewModel.Name)());
                @:}
                @:this.@(method.JsVariableResult)().loadFromDto(data.object);
                }
                }
                else {
                @:this.@(method.JsVariableResult)(data.object);
                }
        
                if (reload) {
                    this.load(callback);
                } else if ($.isFunction(callback)) {
                    callback();
                }
            })
            .fail((xhr) => {
                var errorMsg = "Unknown Error";
                if (xhr.responseJSON && xhr.responseJSON.message) errorMsg = xhr.responseJSON.message;
                this.@(method.JsVariableWasSuccessful)(false);
                this.@(method.JsVariableMessage)(errorMsg);

                //alert("Could not call method @method.JsVariable: " + errorMsg);
            })
            .always(() => {
                this.@(method.JsVariableIsLoading)(false);
            });
        } </text>
        @:// Result of server method (@method.Name) strongly typed in a observable.
        @:public @method.JsVariableResult: @method.ReturnType.TsKnockoutType = @method.ReturnType.JsKnockoutType;
        @:// Raw result object of server method (@method.Name) simply wrapped in an observable.
        @:public @method.JsVariableResultRaw: KnockoutObservable<any> = ko.observable();
        @:// True while the server method (@method.Name) is being called
        @:public @method.JsVariableIsLoading: KnockoutObservable<boolean> = ko.observable(false);
        @:// Error message for server method (@method.Name) if it fails.
        @:public @method.JsVariableMessage: KnockoutObservable<string> = ko.observable(null);
        @:// True if the server method (@method.Name) was successful.
        @:public @method.JsVariableWasSuccessful: KnockoutObservable<boolean> = ko.observable(null);
        @:// Presents a series of input boxes to call the server method (@method.Name)
        @:public @method.JsVariableUi = (callback: () => void = null) => {
            foreach(var param in method.ClientParameters.Where(f=>f.ConvertsFromJsString))
            {
            @:var @param.Name.ToCamelCase(): @param.Type.TsType = @param.Type.TsConvertFromString($"prompt('{param.Name.ToProperCase()}')");
            }
            foreach(var param in method.ClientParameters.Where(f=>!f.ConvertsFromJsString))
            {
            @:var @param.Name: @param.Type.TsType = null;
            }
            @:this.@(method.JsVariable)(@(method.JsArguments("", true)));
        @:}
        @:// Presents a modal with input boxes to call the server method (@method.Name)
        @:public @method.JsVariableModal = (callback: () => void = null) => {
            if (method.ClientParameters.Any()) { 
            @:$('#method-@method.Name').modal();
            @:$('#method-@method.Name').on('shown.bs.modal', () => {
                @:$('#method-@method.Name .btn-ok').unbind('click');
                @:$('#method-@method.Name .btn-ok').click(() => {
                    @:this.@(method.JsVariableWithArgs)(null, callback);
                    @:$('#method-@method.Name').modal('hide');
                @:});
            @:});
            }
            else
            {
            @:this.@(method.JsVariableUi)(callback);
            }
        @:}
        @if (method.ClientParameters.Any())
        {
            @:// Variable for method arguments to allow for easy binding
        @:public @method.JsVariableWithArgs = (args?: @(model.ListViewModelClassName).@(method.ArgsName), callback: () => void = null) => {
            @:if (!args) args = this.@(method.JsVariableArgs);
            @:this.@(method.JsVariable)(@(method.JsArguments("args", true)));
        @:}
        @:public @(method.JsVariableArgs) = new @(model.ListViewModelClassName).@(method.ArgsName)(); 
        }
        @:
        }

        protected createItem = (newItem?: any, parent?: any) => new @viewModelModuleName.@(model.ViewModelClassName)(newItem, parent);

        constructor() {
            super();
        }
    }

    export namespace @(model.ListViewModelClassName) {
        // Classes for use in method calls to support data binding for input for arguments
        @foreach(MethodViewModel method in model.Methods.Where(f => f.ClientParameters.Any() && f.IsStatic && f.IsClientMethod)){
        @:export class @(method.ArgsName) {
            @foreach (var arg in method.ClientParameters)
            {
            @:public @(arg.CsArgumentName): @(arg.Type.TsKnockoutType) = @(arg.Type.JsKnockoutType);
            }
        @:}
        }
    }
}